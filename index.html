<select id="curso">
    <option value="">Selecione seu curso...</option>
    <option>Enfermagem</option> <option>Psicologia</option><option>Medicina</option>
    </select>

<div class="input-group" style="display: flex; align-items: center; gap: 10px; background: rgba(255,255,255,0.05); padding: 10px; border-radius: 12px;">
    <input type="checkbox" id="preferencial" style="width: 20px; height: 20px; cursor: pointer;">
    <label for="preferencial" style="margin: 0; cursor: pointer;">Atendimento Preferencial</label>
</div>

<script type="module">
    // ... importações existentes ...
    import { getFirestore, collection, addDoc, serverTimestamp, onSnapshot, doc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    let idDocumentoAtual = null;

    window.gerar = async () => {
        const nome = document.getElementById('nome').value;
        const cpf = document.getElementById('cpf').value;
        const curso = document.getElementById('curso').value;
        const motivo = document.getElementById('motivo').value;
        const ePreferencial = document.getElementById('preferencial').checked;
        const btn = document.getElementById('btn-gerar');

        if(!nome || !cpf || !curso || !motivo) return alert("Preencha tudo!");

        try {
            btn.disabled = true;
            // Gera prefixo P para preferencial e A para normal
            const prefixo = ePreferencial ? "P" : "A";
            const senha = prefixo + Math.floor(100 + Math.random() * 899);
            
            const docRef = await addDoc(collection(db, "fila"), { 
                nome, cpf, curso, motivo, senha, 
                preferencial: ePreferencial,
                status: "ESPERA", 
                hora: serverTimestamp() 
            });

            idDocumentoAtual = docRef.id;
            
            // Inicia o monitoramento para saber quando ser chamado
            monitorarChamada();

            document.getElementById('form-area').style.display = 'none';
            document.getElementById('sucesso').style.display = 'block';
            document.getElementById('disp-senha').innerText = senha;
            document.getElementById('user-nome').innerText = nome.split(' ')[0];

        } catch (e) { console.error(e); btn.disabled = false; }
    }

    // Função para avisar o aluno na tela dele
    function monitorarChamada() {
        if(!idDocumentoAtual) return;
        
        onSnapshot(doc(db, "fila", idDocumentoAtual), (doc) => {
            if (doc.exists() && doc.data().status === "CHAMANDO") {
                const statusBox = document.querySelector('.status-info');
                statusBox.innerHTML = `
                    <div style="background: #ef4444; padding: 15px; border-radius: 15px; animation: pulse 1.5s infinite;">
                        <h2 style="margin:0; color: white;">SUA VEZ!</h2>
                        <p style="margin:5px 0 0; color: white;">Dirija-se ao guichê de atendimento.</p>
                    </div>
                `;
                // Vibração no celular se disponível
                if (navigator.vibrate) navigator.vibrate([200, 100, 200]);
            }
        });
    }
</script>
