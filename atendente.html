<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ðŸŽ§ Painel do Atendente - Chamadas</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">

    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Poppins', sans-serif;
        }

        body {
            min-height: 100vh;
            background: radial-gradient(circle at top, #0f172a, #020617);
            color: #e5e7eb;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .wrapper {
            width: 100%;
            max-width: 900px;
            background: rgba(15, 23, 42, 0.98);
            border-radius: 20px;
            padding: 22px 20px 20px;
            box-shadow:
                0 22px 50px rgba(15, 23, 42, 0.9),
                0 0 0 1px rgba(148, 163, 184, 0.32);
            position: relative;
            overflow: hidden;
            animation: wrapEnter 0.55s ease-out;
        }

        .wrapper::before {
            content: '';
            position: absolute;
            inset: -30%;
            background:
                radial-gradient(circle at 10% 0%, rgba(59, 130, 246, 0.14), transparent 50%),
                radial-gradient(circle at 90% 0%, rgba(236, 72, 153, 0.16), transparent 55%);
            opacity: 0.9;
            pointer-events: none;
            z-index: -1;
        }

        @keyframes wrapEnter {
            from {
                opacity: 0;
                transform: translateY(20px) scale(0.98);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .top-bar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            margin-bottom: 18px;
        }

        .title-block {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .title-icon {
            width: 44px;
            height: 44px;
            border-radius: 16px;
            background: radial-gradient(circle at 0 0, #3b82f6, #1d4ed8);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            box-shadow: 0 14px 28px rgba(37, 99, 235, 0.7);
            animation: iconPulse 2.4s ease-in-out infinite;
        }

        @keyframes iconPulse {
            0%, 100% {
                transform: scale(1);
                box-shadow: 0 14px 28px rgba(37, 99, 235, 0.7);
            }
            50% {
                transform: scale(1.06);
                box-shadow: 0 20px 36px rgba(37, 99, 235, 0.4);
            }
        }

        .title-text-main {
            font-size: 1.14rem;
            font-weight: 600;
            color: #f9fafb;
        }

        .title-text-sub {
            font-size: 0.8rem;
            color: #9ca3af;
        }

        .status-pill {
            padding: 6px 11px;
            border-radius: 999px;
            font-size: 0.75rem;
            background: rgba(22, 163, 74, 0.18);
            border: 1px solid rgba(34, 197, 94, 0.45);
            color: #bbf7d0;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 999px;
            background: #22c55e;
            box-shadow: 0 0 10px rgba(34, 197, 94, 0.9);
            animation: blinkStatus 1.2s infinite ease-in-out;
        }

        @keyframes blinkStatus {
            0%, 100% {
                opacity: 0.35;
                transform: scale(0.9);
            }
            50% {
                opacity: 1;
                transform: scale(1.08);
            }
        }

        .grid {
            display: grid;
            grid-template-columns: 2.1fr 1.4fr;
            gap: 20px;
        }

        @media (max-width: 768px) {
            .grid {
                grid-template-columns: 1fr;
            }
        }

        .card {
            background: rgba(15, 23, 42, 0.95);
            border-radius: 16px;
            padding: 16px 14px 14px;
            border: 1px solid rgba(148, 163, 184, 0.45);
            box-shadow: 0 10px 26px rgba(15, 23, 42, 0.92);
            position: relative;
            overflow: hidden;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            margin-bottom: 10px;
        }

        .card-title {
            font-size: 0.96rem;
            font-weight: 500;
            color: #e5e7eb;
        }

        .card-subtitle {
            font-size: 0.76rem;
            color: #9ca3af;
        }

        .big-number {
            font-size: 2.2rem;
            font-weight: 700;
            letter-spacing: 0.075em;
            color: #f9fafb;
        }

        .big-label {
            font-size: 0.78rem;
            color: #9ca3af;
        }

        .call-info {
            margin-top: 10px;
            font-size: 0.86rem;
            line-height: 1.45;
        }

        .call-info-strong {
            color: #bfdbfe;
        }

        .btn-row {
            margin-top: 12px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn-main, .btn-sec {
            border-radius: 999px;
            padding: 9px 14px;
            font-size: 0.82rem;
            border: none;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 7px;
            position: relative;
            overflow: hidden;
            transition:
                transform 0.16s ease,
                box-shadow 0.18s ease,
                filter 0.2s ease,
                background-position 0.4s ease;
        }

        .btn-main {
            background: linear-gradient(135deg, #22c55e, #16a34a, #14b8a6);
            color: #f9fafb;
            background-size: 180% 180%;
            box-shadow:
                0 12px 26px rgba(34, 197, 94, 0.55),
                0 0 0 1px rgba(34, 197, 94, 0.35);
            animation: gradientMoveBtn 7s ease infinite;
        }

        @keyframes gradientMoveBtn {
            0% {
                background-position: 0% 50%;
            }
            50% {
                background-position: 100% 50%;
            }
            100% {
                background-position: 0% 50%;
            }
        }

        .btn-main::after, .btn-sec::after {
            content: '';
            position: absolute;
            top: -50%;
            left: -20%;
            width: 40%;
            height: 200%;
            background: linear-gradient(120deg, rgba(255, 255, 255, 0.7), transparent);
            transform: translateX(-120%) skewX(-15deg);
            opacity: 0;
        }

        .btn-main:hover::after, .btn-sec:hover::after {
            animation: shineBtn 0.8s forwards;
        }

        @keyframes shineBtn {
            from {
                transform: translateX(-120%) skewX(-15deg);
                opacity: 0;
            }
            to {
                transform: translateX(210%) skewX(-15deg);
                opacity: 1;
            }
        }

        .btn-sec {
            background: rgba(15, 23, 42, 0.95);
            color: #e5e7eb;
            border: 1px solid rgba(148, 163, 184, 0.75);
            box-shadow: 0 10px 24px rgba(15, 23, 42, 0.85);
        }

        .btn-main:hover, .btn-sec:hover {
            transform: translateY(-1px) scale(1.01);
            filter: brightness(1.03);
        }

        .btn-main:active, .btn-sec:active {
            transform: translateY(0) scale(0.985);
            filter: brightness(0.97);
            box-shadow: 0 7px 16px rgba(15, 23, 42, 0.9);
        }

        .btn-icon {
            font-size: 1rem;
        }

        .queue-list {
            margin-top: 8px;
            border-radius: 12px;
            border: 1px solid rgba(55, 65, 81, 0.9);
            background: rgba(15, 23, 42, 0.96);
            max-height: 280px;
            overflow: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.78rem;
        }

        th, td {
            padding: 7px 9px;
            text-align: left;
            border-bottom: 1px solid rgba(31, 41, 55, 0.95);
        }

        th {
            position: sticky;
            top: 0;
            background: rgba(15, 23, 42, 0.98);
            z-index: 1;
            font-weight: 500;
            color: #9ca3af;
            font-size: 0.76rem;
        }

        tbody tr {
            transition: background-color 0.18s ease, transform 0.12s ease;
        }

        tbody tr:hover {
            background-color: rgba(31, 41, 55, 0.9);
            transform: translateY(-1px);
        }

        .badge-status {
            padding: 3px 7px;
            border-radius: 999px;
            font-size: 0.72rem;
        }

        .badge-aguardando {
            background: rgba(59, 130, 246, 0.18);
            border: 1px solid rgba(59, 130, 246, 0.65);
            color: #bfdbfe;
        }

        .badge-atendido {
            background: rgba(22, 163, 74, 0.16);
            border: 1px solid rgba(34, 197, 94, 0.7);
            color: #bbf7d0;
        }

        .subtitle-queue {
            font-size: 0.78rem;
            color: #9ca3af;
            margin-top: 4px;
        }

        .empty-text {
            font-size: 0.8rem;
            color: #6b7280;
            padding: 12px;
            text-align: center;
        }

        /* Destaque quando nova senha Ã© chamada */
        .highlight-call {
            animation: callFlash 1.5s ease-in-out 1;
        }

        @keyframes callFlash {
            0% {
                box-shadow: 0 0 0 0 rgba(250, 204, 21, 0.05);
                background: rgba(23, 37, 84, 0.9);
            }
            30% {
                box-shadow: 0 0 0 10px rgba(250, 204, 21, 0.02);
                background: rgba(30, 64, 175, 0.9);
            }
            70% {
                box-shadow: 0 0 0 0 rgba(250, 204, 21, 0.0);
                background: rgba(17, 24, 39, 0.96);
            }
            100% {
                box-shadow: none;
                background: rgba(15, 23, 42, 0.95);
            }
        }

        .log-area {
            margin-top: 10px;
            font-size: 0.75rem;
            color: #6b7280;
        }

        .log-entry {
            margin-top: 4px;
        }
    </style>
</head>
<body>
    <div class="wrapper" id="wrapper">
        <div class="top-bar">
            <div class="title-block">
                <div class="title-icon">ðŸŽ§</div>
                <div>
                    <div class="title-text-main">Painel do Atendente</div>
                    <div class="title-text-sub">Acompanhe a fila, chame o prÃ³ximo e visualize os dados do aluno.</div>
                </div>
            </div>
            <div class="status-pill">
                <span class="status-dot"></span>
                <span>Online com Firebase</span>
            </div>
        </div>

        <div class="grid">
            <!-- Bloco principal: senha atual -->
            <div class="card" id="cardAtual">
                <div class="card-header">
                    <div>
                        <div class="card-title">Senha atual</div>
                        <div class="card-subtitle">Dados do aluno sendo atendido</div>
                    </div>
                    <div>
                        <div id="senhaAtual" class="big-number">---</div>
                        <div class="big-label">Senha</div>
                    </div>
                </div>

                <div id="dadosAluno" class="call-info">
                    Nenhum aluno em atendimento no momento.
                </div>

                <div class="btn-row">
                    <button class="btn-main" id="btnChamar">
                        <span class="btn-icon">ðŸ“¢</span>
                        <span>Chamar PrÃ³ximo</span>
                    </button>
                    <button class="btn-sec" id="btnFinalizar">
                        <span class="btn-icon">âœ…</span>
                        <span>Finalizar Atendimento</span>
                    </button>
                </div>

                <div class="log-area" id="logArea"></div>
            </div>

            <!-- Bloco lateral: fila -->
            <div class="card">
                <div class="card-header">
                    <div>
                        <div class="card-title">Fila de espera</div>
                        <div class="card-subtitle">Alunos aguardando atendimento</div>
                    </div>
                </div>

                <div class="queue-list">
                    <table>
                        <thead>
                            <tr>
                                <th>Senha</th>
                                <th>Nome</th>
                                <th>Curso</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="tbodyFila">
                            <tr>
                                <td colspan="4" class="empty-text">Carregando fila...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div class="subtitle-queue">
                    A lista Ã© atualizada automaticamente conforme os alunos geram e finalizam senhas.
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase v8 -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <script>
        // TODO: mesma config do index.html
        const firebaseConfig = {
            apiKey: "SUA_API_KEY",
            authDomain: "SEU_AUTH_DOMAIN",
            databaseURL: "SUA_DATABASE_URL",
            projectId: "SEU_PROJECT_ID",
            storageBucket: "SEU_BUCKET",
            messagingSenderId: "SEU_SENDER_ID",
            appId: "SEU_APP_ID"
        };

        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        const senhaAtualEl = document.getElementById('senhaAtual');
        const dadosAlunoEl = document.getElementById('dadosAluno');
        const tbodyFila = document.getElementById('tbodyFila');
        const btnChamar = document.getElementById('btnChamar');
        const btnFinalizar = document.getElementById('btnFinalizar');
        const cardAtual = document.getElementById('cardAtual');
        const logArea = document.getElementById('logArea');

        let senhaAtualId = null;
        let filaCache = {};

        function addLog(mensagem) {
            const hora = new Date().toLocaleTimeString('pt-BR', { hour12: false });
            const div = document.createElement('div');
            div.className = 'log-entry';
            div.textContent = `[${hora}] ${mensagem}`;
            logArea.prepend(div);
        }

        function atualizarTabelaFila() {
            tbodyFila.innerHTML = '';

            const chaves = Object.keys(filaCache);
            if (chaves.length === 0) {
                const tr = document.createElement('tr');
                const td = document.createElement('td');
                td.colSpan = 4;
                td.className = 'empty-text';
                td.textContent = 'Nenhum aluno aguardando na fila.';
                tr.appendChild(td);
                tbodyFila.appendChild(tr);
                return;
            }

            // ordenar por timestamp asc
            chaves.sort((a, b) => {
                return (filaCache[a].timestamp || 0) - (filaCache[b].timestamp || 0);
            });

            chaves.forEach(key => {
                const dados = filaCache[key];
                const tr = document.createElement('tr');

                const tdSenha = document.createElement('td');
                tdSenha.textContent = dados.senha || '---';

                const tdNome = document.createElement('td');
                tdNome.textContent = dados.nome || '-';

                const tdCurso = document.createElement('td');
                tdCurso.textContent = dados.curso || '-';

                const tdStatus = document.createElement('td');
                const spanStatus = document.createElement('span');
                spanStatus.classList.add('badge-status');
                if (dados.status === 'atendido') {
                    spanStatus.classList.add('badge-atendido');
                    spanStatus.textContent = 'Atendido';
                } else {
                    spanStatus.classList.add('badge-aguardando');
                    spanStatus.textContent = 'Aguardando';
                }
                tdStatus.appendChild(spanStatus);

                tr.appendChild(tdSenha);
                tr.appendChild(tdNome);
                tr.appendChild(tdCurso);
                tr.appendChild(tdStatus);

                tbodyFila.appendChild(tr);
            });
        }

        // Observa filaSenhas em tempo real
        database.ref('filaSenhas').on('value', (snapshot) => {
            filaCache = snapshot.val() || {};
            atualizarTabelaFila();
        });

        // Observa proximaSenha em tempo real (caso outro atendente use tambÃ©m)
        database.ref('proximaSenha').on('value', (snapshot) => {
            const proxima = snapshot.val();
            if (!proxima || !proxima.id) {
                // nada pendente
                return;
            }
            // nÃ£o chamamos aqui automaticamente para nÃ£o bagunÃ§ar fluxo de botÃ£o
        });

        btnChamar.addEventListener('click', async () => {
            try {
                // busca a fila atual
                const snap = await database.ref('filaSenhas').once('value');
                const fila = snap.val() || {};
                const chaves = Object.keys(fila);

                if (chaves.length === 0) {
                    addLog('Tentativa de chamar prÃ³ximo sem alunos na fila.');
                    cardAtual.classList.remove('highlight-call');
                    void cardAtual.offsetWidth;
                    cardAtual.classList.add('highlight-call');
                    return;
                }

                // ordena por timestamp
                chaves.sort((a, b) => {
                    return (fila[a].timestamp || 0) - (fila[b].timestamp || 0);
                });

                const primeiraChave = chaves[0];
                const dados = fila[primeiraChave];

                senhaAtualId = primeiraChave;

                // atualiza UI
                senhaAtualEl.textContent = dados.senha || '---';
                dadosAlunoEl.innerHTML = `
                    <span class="call-info-strong">Aluno:</span> ${dados.nome || '-'}<br>
                    MatrÃ­cula: ${dados.matricula || '-'}<br>
                    Curso: ${dados.curso || '-'}<br>
                    ${dados.responsavel ? 'ResponsÃ¡vel: ' + dados.responsavel + '<br>' : ''}
                    ${dados.motivo ? 'Motivo: ' + dados.motivo : ''}
                `;

                cardAtual.classList.remove('highlight-call');
                void cardAtual.offsetWidth;
                cardAtual.classList.add('highlight-call');

                addLog(`Chamando prÃ³xima senha: ${dados.senha} - ${dados.nome || ''}`);

                // marca esta senha como proximaSenha
                await database.ref('proximaSenha').set({
                    id: primeiraChave,
                    senha: dados.senha
                });
            } catch (err) {
                console.error(err);
                addLog('Erro ao chamar prÃ³ximo aluno.');
            }
        });

        btnFinalizar.addEventListener('click', async () => {
            if (!senhaAtualId) {
                addLog('Nenhuma senha atual para finalizar.');
                return;
            }

            try {
                const refSenha = database.ref('filaSenhas/' + senhaAtualId);
                const snap = await refSenha.once('value');
                const dados = snap.val();

                if (!dados) {
                    addLog('A senha atual nÃ£o existe mais na fila.');
                } else {
                    // move para histÃ³rico
                    await database.ref('historico').push({
                        ...dados,
                        status: 'atendido',
                        finalizadoEm: firebase.database.ServerValue.TIMESTAMP
                    });
                    await refSenha.remove();
                    addLog(`Atendimento finalizado para a senha: ${dados.senha}`);
                }

                // limpa proximaSenha se for esta
                const proxSnap = await database.ref('proximaSenha').once('value');
                const prox = proxSnap.val();
                if (prox && prox.id === senhaAtualId) {
                    await database.ref('proximaSenha').remove();
                }

                senhaAtualId = null;
                senhaAtualEl.textContent = '---';
                dadosAlunoEl.textContent = 'Nenhum aluno em atendimento no momento.';
            } catch (err) {
                console.error(err);
                addLog('Erro ao finalizar atendimento.');
            }
        });
    </script>
</body>
</html>
